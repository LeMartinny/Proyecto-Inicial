{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mis Cursos</title>

<!-- Fuente Alice -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Alice&display=swap" rel="stylesheet">
<link rel="icon" type="image/png" size="32x32" href="{% static 'img/logo.png' %}"/>

<style>
/* ==========================
   CSS Extendido del HTML de Cursos
========================== */
* { margin:0; padding:0; box-sizing:border-box; }

body {
    font-family: 'Alice', serif;
    background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
    min-height: 100vh;
    color: white;
    overflow-x: hidden;
    padding: 20px;
}

.container {
    max-width: 1280px;
    margin: 0 auto;
    padding: 0 1.5rem;
}

.header {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin-bottom: 2rem;
}

.header h1 {
    font-size: 2.5rem;
    text-decoration: underline;
    text-decoration-color: #60a5fa;
    text-underline-offset: 10px;
    text-decoration-thickness: 4px;
}

.header p {
    color: #b0b0b0;
    font-size: 1.1rem;
}

.cursos-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 2rem;
}

/* Tarjetas de curso */
.curso-card {
    background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    cursor: pointer;
    transition: transform 0.3s ease, box-shadow 0.3s ease, border 0.3s ease;
    border: 2px solid transparent;
}

.curso-card:hover {
    transform: translateY(-10px) scale(1.02);
    box-shadow: 0 20px 60px rgba(96,165,250,0.3);
    border-color: #60a5fa;
}

.curso-imagen {
    width: 100%;
    height: 180px;
    object-fit: cover;
    background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #64B5F6;
    font-size: 3em;
}

.curso-contenido {
    padding: 1.5rem;
    text-align: center;
}

.curso-titulo {
    font-size: 1.6rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.curso-descripcion {
    color: #b0b0b0;
    font-size: 0.95rem;
    margin-bottom: 1rem;
}

.btn-inscribir, .btn-comenzar, .desinscribir {
    display: inline-block;
    margin: 0.3rem;
    padding: 10px 20px;
    border-radius: 25px;
    font-weight: 600;
    text-decoration: none;
    cursor: pointer;
    transition: all 0.3s ease;
    border: none;
}

.btn-comenzar, .btn-inscribir {
    background: #64B5F6;
    color: white;
}

.btn-comenzar:hover, .btn-inscribir:hover {
    background: #90CAF9;
    transform: translateY(-2px);
}

.desinscribir {
    background: #d9534f;
    color: white;
}

.desinscribir:hover {
    background: #c9302c;
}

.badge {
    display: inline-block;
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.85em;
    font-weight: 600;
    margin-bottom: 10px;
}

.badge-activo {
    background: rgba(100,181,246,0.2);
    color: #64B5F6;
    border: 1px solid #64B5F6;
}

.badge-completado {
    background: rgba(33,150,243,0.2);
    color: #2196F3;
    border: 1px solid #2196F3;
}

.empty-state {
    background: #2a2a2a;
    padding: 60px 40px;
    border-radius: 15px;
    text-align: center;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    border: 1px solid #3a3a3a;
}

.empty-icon { font-size: 5em; margin-bottom: 20px; opacity:0.5; }

@media (max-width:768px) {
    .cursos-grid { grid-template-columns: 1fr; }
    .header h1 { font-size: 1.8rem; }
}
</style>
</head>
<body>
<div class="container">
    <div class="header">
        <a href="{% url 'usuarios:perfil' %}" class="btn-inscribir">‚Üê Volver al Perfil</a>
        <h1>üìö Mis Cursos</h1>
        <p>Gestiona y contin√∫a tu aprendizaje en econom√≠a</p>
    </div>

    <div id="cursosContainer">
        {% if cursos_inscritos %}
        <div class="cursos-grid">
            {% for curso in cursos_inscritos %}
            <div class="curso-card">
                <div class="curso-imagen">{{ curso.icono }}</div>
                <div class="curso-contenido">
                    <h3 class="curso-titulo">{{ curso.titulo }}</h3>
                    <p class="curso-descripcion">{{ curso.descripcion|truncatewords:15 }}</p>

                    <span class="badge {% if curso.completado %}badge-completado{% else %}badge-activo{% endif %}">
                        {% if curso.completado %}Completado{% else %}En progreso{% endif %}
                    </span>

                    <div class="curso-progreso">
                        <div class="progreso-label">
                            <span>Progreso</span>
                            <span><strong>{{ curso.progreso }}%</strong></span>
                        </div>
                        <div class="progreso-bar">
                            <div class="progreso-fill" style="width: {{ curso.progreso }}%"></div>
                        </div>
                    </div>

                    <a href="{% url 'cursos:ver_curso' curso.codigo %}" class="btn-comenzar">Comenzar</a>
                    {% comment %}
                    Enlace antiguo (lo usaremos m√°s adelante):
                    <a href="{% url 'cursos:detalle_curso' curso.id %}" class="btn-comenzar">Comenzar</a>
                    {% endcomment %}
                    <button class="desinscribir" onclick="desinscribir('{{ curso.codigo }}', this)">Desinscribirme</button>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-icon">üìñ</div>
            <h2>No tienes cursos inscritos</h2>
            <p>Comienza tu viaje de aprendizaje inscribi√©ndote en alguno de nuestros cursos de econom√≠a.</p>
            <a href="{% url 'cursos:lista_cursos' %}" class="btn-inscribir">Explorar Cursos</a>
        </div>
        {% endif %}
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    var HAS_SERVER_COURSES = {% if cursos_inscritos %}true{% else %}false{% endif %};
    const cursosDisponibles = [
        { id: 1, titulo: "Ahorro y Gastos", icono: "üè¶", descripcion: "Controla tus gastos y ahorra m√°s", link: "ahorrogasto.html" },
        { id: 2, titulo: "Inflaci√≥n", icono: "üìä", descripcion: "Comprende el impacto de la inflaci√≥n", link: "inflacion.html" },
        { id: 3, titulo: "Inversi√≥n", icono: "üìà", descripcion: "Aprende d√≥nde y c√≥mo invertir tu dinero", link: "inversion.html" },
        { id: 4, titulo: "Presupuesto", icono: "üí∞", descripcion: "Aprende a gestionar tu presupuesto personal", link: "presupuesto.html" }
    ];

    let inscritos = JSON.parse(localStorage.getItem("cursos_inscritos")) || [];

    const contenedor = document.getElementById("cursosContainer");

    function render() {
        contenedor.innerHTML = "";

        if (inscritos.length === 0) {
            contenedor.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">üìñ</div>
                    <h2>No tienes cursos inscritos</h2>
                    <p>Comienza tu viaje de aprendizaje inscribi√©ndote en alguno de nuestros cursos.</p>
                    <a href="{% url 'cursos:lista_cursos' %}" class="btn-inscribir">Explorar Cursos</a>
                </div>
            `;
            return;
        }

        const grid = document.createElement("div");
        grid.className = "cursos-grid";

        inscritos.forEach(id => {
            const curso = cursosDisponibles.find(c => c.id === id);
            if (!curso) return;

            const card = document.createElement("div");
            card.className = "curso-card";

            card.innerHTML = `
                <div class="curso-imagen">${curso.icono}</div>
                <div class="curso-contenido">
                    <h3 class="curso-titulo">${curso.titulo}</h3>
                    <p class="curso-descripcion">${curso.descripcion}</p>

                    <span class="badge badge-activo">En progreso</span>

                    <div class="curso-progreso">
                        <div class="progreso-label">
                            <span>Progreso</span>
                            <span><strong>0%</strong></span>
                        </div>
                        <div class="progreso-bar">
                            <div class="progreso-fill" style="width: 0%"></div>
                        </div>
                    </div>

                    <a href="${curso.link}" class="btn-comenzar">Ir</a>
                    <button class="desinscribir" onclick="desinscribir(${curso.id})">Desinscribirme</button>
                </div>
            `;
            grid.appendChild(card);
        });

        contenedor.appendChild(grid);
    }

    // Helper CSRF para POST y endpoint de backend
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const desinscribirUrlTpl = "{% url 'cursos:desinscribir_curso' 'REPLACE_CODE' %}";

    window.desinscribir = async function(arg, btn) {
        // Fallback local (cuando no hay cursos del servidor)
        if (typeof arg === 'number') {
            inscritos = inscritos.filter(x => x !== arg);
            localStorage.setItem("cursos_inscritos", JSON.stringify(inscritos));
            if (!HAS_SERVER_COURSES) {
                render();
            }
            return;
        }

        // Backend + limpieza de localStorage para evitar re-sync
        const codigo = String(arg);
        const url = desinscribirUrlTpl.replace('REPLACE_CODE', codigo);
        try {
            const resp = await fetch(url, { method: 'POST', headers: { 'X-CSRFToken': getCookie('csrftoken') } });
            if (!resp.ok) throw new Error('fail');
        } catch (_) {
            return; 
        }

        try {
            let arr = JSON.parse(localStorage.getItem("cursos_inscritos")) || [];
            arr = arr.filter(k => k !== codigo);
            localStorage.setItem("cursos_inscritos", JSON.stringify(arr));
        } catch (_) {}

        if (btn && btn.closest) {
            const card = btn.closest('.curso-card');
            if (card) card.remove();
        } else {
            window.location.reload();
        }
    }

    if (!HAS_SERVER_COURSES) {
        render();
    }
});
</script>
</body>
</html>
