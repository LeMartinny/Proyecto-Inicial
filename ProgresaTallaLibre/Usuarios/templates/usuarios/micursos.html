{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mis Cursos</title>

<!-- Fuente Alice -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Alice&display=swap" rel="stylesheet">
<link rel="icon" type="image/png" size="32x32" href="{% static 'img/logo.png' %}"/>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body class="page-mis-cursos">
<div class="container">
    <div class="header">
        <a href="{% url 'usuarios:perfil' %}" class="btn-inscribir">‚Üê Volver al Perfil</a>
        <h1>üìö Mis Cursos</h1>
        <p>Gestiona y contin√∫a tu aprendizaje en econom√≠a</p>
    </div>

    <div id="cursosContainer">
        {% if cursos_inscritos %}
        <div class="cursos-grid">
            {% for curso in cursos_inscritos %}
            <div class="curso-card">
                <div class="curso-imagen">{{ curso.icono }}</div>
                <div class="curso-contenido">
                    <h3 class="curso-titulo">{{ curso.titulo }}</h3>
                    <p class="curso-descripcion">{{ curso.descripcion|truncatewords:15 }}</p>

                    <span class="badge {% if curso.completado %}badge-completado{% else %}badge-activo{% endif %}">
                        {% if curso.completado %}Completado{% else %}En progreso{% endif %}
                    </span>

                    <div class="curso-progreso">
                        <div class="progreso-label">
                            <span>Progreso</span>
                            <span><strong>{{ curso.progreso }}%</strong></span>
                        </div>
                        <div class="progreso-bar">
                            <div class="progreso-fill" style="width: {{ curso.progreso }}%"></div>
                        </div>
                    </div>

                    <a href="{% url 'cursos:ver_curso' curso.codigo %}" class="btn-comenzar">Comenzar</a>
                    {% comment %}
                    Enlace antiguo (lo usaremos m√°s adelante):
                    <a href="{% url 'cursos:detalle_curso' curso.id %}" class="btn-comenzar">Comenzar</a>
                    {% endcomment %}
                    <button class="desinscribir" onclick="desinscribir('{{ curso.codigo }}', this)">Desinscribirme</button>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-icon">üìñ</div>
            <h2>No tienes cursos inscritos</h2>
            <p>Comienza tu viaje de aprendizaje inscribi√©ndote en alguno de nuestros cursos de econom√≠a.</p>
            <a href="{% url 'cursos:lista_cursos' %}" class="btn-inscribir">Explorar Cursos</a>
        </div>
        {% endif %}
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const STORAGE_KEY = "{{ storage_key|default:'cursos_inscritos'|escapejs }}";
    const LEGACY_KEY = "cursos_inscritos";

    function readStoredCourses(key) {
        try {
            const raw = localStorage.getItem(key);
            if (!raw) return [];
            const parsed = JSON.parse(raw);
            return Array.isArray(parsed) ? parsed : [];
        } catch (_) {
            return [];
        }
    }

    function writeStoredCourses(data) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    if (STORAGE_KEY !== LEGACY_KEY) {
        const legacyCourses = readStoredCourses(LEGACY_KEY);
        if (!localStorage.getItem(STORAGE_KEY) && legacyCourses.length) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(legacyCourses));
        }
        localStorage.removeItem(LEGACY_KEY);
    }

    var HAS_SERVER_COURSES = {% if cursos_inscritos %}true{% else %}false{% endif %};
    const cursosDisponibles = [
        { id: 1, titulo: "Ahorro y Gastos", icono: "üè¶", descripcion: "Controla tus gastos y ahorra m√°s", link: "ahorrogasto.html" },
        { id: 2, titulo: "Inflaci√≥n", icono: "üìä", descripcion: "Comprende el impacto de la inflaci√≥n", link: "inflacion.html" },
        { id: 3, titulo: "Inversi√≥n", icono: "üìà", descripcion: "Aprende d√≥nde y c√≥mo invertir tu dinero", link: "inversion.html" },
        { id: 4, titulo: "Presupuesto", icono: "üí∞", descripcion: "Aprende a gestionar tu presupuesto personal", link: "presupuesto.html" }
    ];

    let inscritos = readStoredCourses(STORAGE_KEY);

    const contenedor = document.getElementById("cursosContainer");

    function render() {
        contenedor.innerHTML = "";

        if (inscritos.length === 0) {
            contenedor.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">üìñ</div>
                    <h2>No tienes cursos inscritos</h2>
                    <p>Comienza tu viaje de aprendizaje inscribi√©ndote en alguno de nuestros cursos.</p>
                    <a href="{% url 'cursos:lista_cursos' %}" class="btn-inscribir">Explorar Cursos</a>
                </div>
            `;
            return;
        }

        const grid = document.createElement("div");
        grid.className = "cursos-grid";

        inscritos.forEach(id => {
            const curso = cursosDisponibles.find(c => c.id === id);
            if (!curso) return;

            const card = document.createElement("div");
            card.className = "curso-card";

            card.innerHTML = `
                <div class="curso-imagen">${curso.icono}</div>
                <div class="curso-contenido">
                    <h3 class="curso-titulo">${curso.titulo}</h3>
                    <p class="curso-descripcion">${curso.descripcion}</p>

                    <span class="badge badge-activo">En progreso</span>

                    <div class="curso-progreso">
                        <div class="progreso-label">
                            <span>Progreso</span>
                            <span><strong>0%</strong></span>
                        </div>
                        <div class="progreso-bar">
                            <div class="progreso-fill" style="width: 0%"></div>
                        </div>
                    </div>

                    <a href="${curso.link}" class="btn-comenzar">Ir</a>
                    <button class="desinscribir" onclick="desinscribir(${curso.id})">Desinscribirme</button>
                </div>
            `;
            grid.appendChild(card);
        });

        contenedor.appendChild(grid);
    }

    // Helper CSRF para POST y endpoint de backend
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const desinscribirUrlTpl = "{% url 'cursos:desinscribir_curso' 'REPLACE_CODE' %}";

    window.desinscribir = async function(arg, btn) {
        // Fallback local (cuando no hay cursos del servidor)
        if (typeof arg === 'number') {
            inscritos = inscritos.filter(x => x !== arg);
            writeStoredCourses(inscritos);
    
            return window.location.reload();
        }

        // Backend + limpieza de localStorage para evitar re-sync
        const codigo = String(arg);
        const url = desinscribirUrlTpl.replace('REPLACE_CODE', codigo);
        try {
            const resp = await fetch(url, { method: 'POST', headers: { 'X-CSRFToken': getCookie('csrftoken') } });
            if (!resp.ok) throw new Error('fail');
        } catch (_) {
            return; 
        }

        try {
            let arr = readStoredCourses(STORAGE_KEY);
            arr = arr.filter(k => k !== codigo);
            writeStoredCourses(arr);
        } catch (_) {}
        
        window.location.reload();
    }

    if (!HAS_SERVER_COURSES) {
        render();
    }
});
</script>
</body>
</html>
