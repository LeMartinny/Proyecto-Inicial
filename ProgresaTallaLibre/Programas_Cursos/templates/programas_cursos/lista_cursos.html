{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cursos - Progresa Libre</title>
    
    <!-- Fuente Alice -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Alice&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body class="page-lista-cursos">

    <!-- Overlay de fondo -->
    <div class="overlay" id="overlay"></div>
    
    <!-- Panel lateral -->
    <div class="side-panel" id="sidePanel">
        <div class="panel-content">
            <div class="panel-header">
                <div style="flex: 1;"></div>
                <button class="close-panel-btn" id="closePanelBtn">‚úï</button>
            </div>
            <div class="panel-icon" id="panelIcon">üí∞</div>
            <h2 class="panel-title" id="panelTitle">Presupuesto Personal</h2>
            <p class="panel-description" id="panelDescription">
                Descripci√≥n del curso aqu√≠...
            </p>
            <div class="panel-features" id="panelFeatures">
                <h4>Lo que aprender√°s:</h4>
                <ul id="featuresList">
                    <li>Caracter√≠stica 1</li>
                    <li>Caracter√≠stica 2</li>
                    <li>Caracter√≠stica 3</li>
                </ul>
            </div>
            <div class="curso-card" data-curso-codigo="{{ curso.codigo }}">

                <button class="inscribir-btn" data-curso-codigo="{{ curso.codigo }}">
                    {% if curso.esta_inscrito %}Curso Inscrito{% else %}Inscribir Curso{% endif %}
                </button>
            </div>
        </div>
    </div>
    
    <div class="container">
    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <a href="{% url 'usuarios:perfil' %}" class="logo-link">
                <div class="logo-container">
                    <img src="https://images.unsplash.com/photo-1579621970563-ebec7560ff3e?w=100&h=100&fit=crop" alt="Logo Progresa Libre">
                </div>
            </a>
            <h1 class="page-title">Cursos</h1>
        </div>

        <a href="{% url 'usuarios:perfil' %}" class="perfil-btn">
            <img src="https://i.imgur.com/exit-icon.png" alt="Perfil" class="perfil-icon">
            <span>Al Perfil</span>
        </a>
    </div>
        <!-- Grid de Cursos -->
        <div class="cursos-grid">
            <!-- Curso 1: Presupuesto Personal -->
            <div class="curso-card" data-curso="presupuesto-personal">
                <div class="curso-image-container">
                    <img src="https://images.unsplash.com/photo-1554224155-6726b3ff858f?w=800&q=80" 
                         alt="Presupuesto Personal" 
                         class="curso-image">
                    <div class="curso-overlay"></div>
                    <div class="action-button">‚Üí</div>
                </div>
                <div class="curso-content">
                    <h2 class="curso-title">Presupuesto Personal</h2>
                    <p class="curso-subtitle">Aprende a gestionar tus finanzas</p>
                </div>
            </div>
            
            <!-- Curso 2: Tipos de Inversi√≥n -->
            <div class="curso-card" data-curso="tipos-inversion">
                <div class="curso-image-container">
                    <img src="https://images.unsplash.com/photo-1611974789855-9c2a0a7236a3?w=800&q=80" 
                         alt="Tipos de Inversi√≥n" 
                         class="curso-image">
                    <div class="curso-overlay"></div>
                    <div class="action-button">‚Üí</div>
                </div>
                <div class="curso-content">
                    <h2 class="curso-title">Tipos de Inversi√≥n</h2>
                    <p class="curso-subtitle">Descubre d√≥nde invertir tu dinero</p>
                </div>
            </div>
            
            <!-- Curso 3: Ahorro y Gasto -->
            <div class="curso-card" data-curso="ahorro-gasto">
                <div class="curso-image-container">
                    <img src="https://images.unsplash.com/photo-1579621970563-ebec7560ff3e?w=800&q=80" 
                         alt="Ahorro y Gasto" 
                         class="curso-image">
                    <div class="curso-overlay"></div>
                    <div class="action-button">‚Üí</div>
                </div>
                <div class="curso-content">
                    <h2 class="curso-title">Ahorro y Gasto</h2>
                    <p class="curso-subtitle">Controla tus gastos y ahorra m√°s</p>
                </div>
            </div>
            
            <!-- Curso 4: Inflaci√≥n -->
            <div class="curso-card" data-curso="inflacion">
                <div class="curso-image-container">
                    <img src="https://images.unsplash.com/photo-1621761191319-c6fb62004040?w=800&q=80" 
                         alt="Inflaci√≥n" 
                         class="curso-image">
                    <div class="curso-overlay"></div>
                    <div class="action-button">‚Üí</div>
                </div>
                <div class="curso-content">
                    <h2 class="curso-title">Inflaci√≥n</h2>
                    <p class="curso-subtitle">Entiende el impacto de la inflaci√≥n</p>
                </div>
            </div>
        </div>
    </div>
<script>
document.addEventListener("DOMContentLoaded", () => {

    // CSRF helper (Django)
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const enrollUrlTemplate = "{% url 'cursos:inscribir_curso' 'REPLACE_ME' %}";

    async function inscribirCursoBackend(key) {
        const url = enrollUrlTemplate.replace('REPLACE_ME', key);
        const resp = await fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        if (!resp.ok) throw new Error('Fallo al inscribir en el servidor');
        const data = await resp.json().catch(() => ({}));
        if (data.status && data.status !== 'ok' && !(data.message || '').includes('inscrito')) {
            throw new Error(data.message || 'Inscripci√≥n rechazada');
        }
        return true;
    }

    const STORAGE_KEY = "{{ storage_key|default:'cursos_inscritos'|escapejs }}";
    const LEGACY_KEY = "cursos_inscritos";

    function readStoredCourses(key) {
        try {
            const raw = localStorage.getItem(key);
            if (!raw) return [];
            const parsed = JSON.parse(raw);
            return Array.isArray(parsed) ? parsed : [];
        } catch (_) {
            return [];
        }
    }

    function persistInscritos() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(inscritos));
    }

    if (STORAGE_KEY !== LEGACY_KEY) {
        const legacyCourses = readStoredCourses(LEGACY_KEY);
        if (!localStorage.getItem(STORAGE_KEY) && legacyCourses.length) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(legacyCourses));
        }
        localStorage.removeItem(LEGACY_KEY);
    }

    // Datos de cursos
    const cursosData = {
        'presupuesto-personal': {
            icon: 'üí∞',
            title: 'Presupuesto Personal',
            description: 'Aprende a gestionar tus finanzas.',
            features: [
                'Crea presupuestos mensuales efectivos',
                'Controla ingresos y gastos',
                'Establece metas financieras alcanzables'
            ]
        },
        'tipos-inversion': {
            icon: 'üìà',
            title: 'Tipos de Inversi√≥n',
            description: 'Conoce distintas estrategias de inversi√≥n.',
            features: [
                'Aprende sobre acciones y bonos',
                'Eval√∫a riesgos de inversi√≥n',
                'Diversifica tu portafolio'
            ]
        },
        'ahorro-gasto': {
            icon: 'üè¶',
            title: 'Ahorro y Gasto',
            description: 'Controla tus gastos y ahorra m√°s.',
            features: [
                'Reduce gastos innecesarios',
                'Construye un fondo de ahorro',
                'Alcanza tus metas financieras'
            ]
        },
        'inflacion': {
            icon: 'üìä',
            title: 'Inflaci√≥n',
            description: 'Comprende el impacto de la inflaci√≥n.',
            features: [
                'Entiende c√≥mo funciona la inflaci√≥n',
                'Protege tus ahorros',
                'Toma decisiones financieras informadas'
            ]
        }
    };

    // Cargar inscritos desde localStorage
    let inscritos = readStoredCourses(STORAGE_KEY);

    // Sincronizar localStorage -> backend para mantener coherencia
    (async function syncLocalToServer() {
        try {
            for (const key of inscritos) {
                try { await inscribirCursoBackend(key); } catch (e) { /* silencioso */ }
            }
        } catch (_) {}
    })();

    const cursoCards = document.querySelectorAll(".curso-card");
    const sidePanel = document.getElementById("sidePanel");
    const overlay = document.getElementById("overlay");
    const closePanelBtn = document.getElementById("closePanelBtn");

    const panelIcon = document.getElementById("panelIcon");
    const panelTitle = document.getElementById("panelTitle");
    const panelDescription = document.getElementById("panelDescription");
    const featuresList = document.getElementById("featuresList");
    const panelBtn = sidePanel.querySelector(".inscribir-btn");

    // Funci√≥n para actualizar botones seg√∫n inscripci√≥n
    function actualizarBotones() {
        cursoCards.forEach(card => {
            const key = card.dataset.curso;
            const btn = card.querySelector(".action-button");
            if (!btn) return;

            if (inscritos.includes(key)) {
                btn.textContent = "‚úì";
                btn.classList.add("inscrito");
            } else {
                btn.textContent = "‚Üí";
                btn.classList.remove("inscrito");
            }
        });

        // Panel lateral
        if (panelBtn && inscritos.includes(panelBtn.dataset.cursoCodigo)) {
            panelBtn.textContent = "Curso Inscrito";
            panelBtn.disabled = true;
            panelBtn.classList.add("inscrito");
        } else if (panelBtn) {
            panelBtn.textContent = "Inscribirme";
            panelBtn.disabled = false;
            panelBtn.classList.remove("inscrito");
        }
    }

    actualizarBotones();

    // Abrir panel al click en tarjeta
    cursoCards.forEach(card => {
        card.addEventListener("click", (e) => {
            // Evitar conflicto si clic en el bot√≥n de acci√≥n
            if (e.target.classList.contains("action-button")) {
                const key = card.dataset.curso;
                if (!inscritos.includes(key)) {
                    inscribirCursoBackend(key)
                        .then(() => {
                            inscritos.push(key);
                            persistInscritos();
                            actualizarBotones();
                        })
                        .catch(() => {
                            // No actualizamos UI si falla backend
                        });
                }
                return;
            }

            const key = card.dataset.curso;
            const curso = cursosData[key];
            if (!curso) return;

            panelIcon.textContent = curso.icon;
            panelTitle.textContent = curso.title;
            panelDescription.textContent = curso.description;
            featuresList.innerHTML = curso.features.map(f => `<li>${f}</li>`).join("");
            panelBtn.dataset.cursoCodigo = key;

            sidePanel.classList.add("open");
            overlay.classList.add("show");

            actualizarBotones();
        });
    });

    // Cerrar panel
    function cerrarPanel() {
        sidePanel.classList.remove("open");
        overlay.classList.remove("show");
    }

    closePanelBtn.addEventListener("click", cerrarPanel);
    overlay.addEventListener("click", cerrarPanel);

    // Inscripci√≥n desde panel lateral
    panelBtn.addEventListener("click", () => {
        const key = panelBtn.dataset.cursoCodigo;
        if (!inscritos.includes(key)) {
            inscribirCursoBackend(key)
                .then(() => {
                    inscritos.push(key);
                    persistInscritos();
                    actualizarBotones();
                })
                .catch(() => {
                    // No actualizamos UI si falla backend
                });
        }
    });
});
</script>   
</body>
</html>
