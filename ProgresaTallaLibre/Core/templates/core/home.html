{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Progresa Libre</title>

  <!-- Fuentes-->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Alice&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{% static 'css/style.css' %}">
<!-- Asegurar misma fuente que en lista_cursos y estilos para el título -->
<style>
    /* Coincide con lista_cursos: usar Alice para todo el home */
    body, .title-primary, .title-secondary, .page-title {
        font-family: 'Alice', serif !important;
    }

        /* Títulos más gruesos y con animación */
        /* Evitar recorte de descendentes (g, y, p) asegurando overflow visible y suficiente line-height */
        .title-block, .title-row {
            overflow: visible !important;
        }

        .title-primary, .title-secondary {
            display: inline-block; /* permite transform */
            font-weight: 900; /* más grueso */
            letter-spacing: 1px;
            line-height: 1.05; /* evita cortar las descendentes */
            padding-bottom: 0.06em; /* pequeño espacio para descender */
            text-shadow: 0 6px 24px rgba(0,0,0,0.35);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            background-image: linear-gradient(90deg, #ffffff 0%, #ffe29f 45%, #ffffff 70%);
            background-size: 200% 100%;
            animation: titleShimmer 3s linear infinite, titlePop 4s ease-in-out infinite;
            transform-origin: center bottom;
        }

        /* Slightly different timing for the secondary word to create a staggered effect */
        .title-secondary {
            animation-duration: 3.5s, 4.5s;
        }

        @keyframes titleShimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        @keyframes titlePop {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-6px) scale(1.03); }
        }
</style>
</head>
<body{% if messages %} data-has-messages="true"{% endif %}>

  <!-- HomePage -->
    <div id="HomePage" class="main-container">
        <div class="left-section"></div>
        <div class="divider"></div>
        <div class="right-section">
        
            <nav>
                <div class="separador">
                    <a href="#quienes-somos">¿QUIENES SOMOS?</a>
                    {% if is_authenticated %}
                        <a href="{% url 'lista_cursos' %}">PROGRAMAS</a>
                        <a href="{% url 'usuarios:perfil' %}">TU PERFIL</a>
                    {% else %}
                        <!-- Abrir modal de login/registro si no está autenticado.
                             data-default-tab: 'login'|'signup'
                             data-subtitle: texto a mostrar en el modal -->
                        <a href="#auth-modal" class="js-open-auth" data-default-tab="login" data-subtitle="Debes iniciar sesión primero">PROGRAMAS</a>
                        <a href="#auth-modal" class="js-open-auth" data-default-tab="login" data-subtitle="Bienvenido de vuelta">TU PERFIL</a>
                    {% endif %}
                </div>
            </nav>

            <!-- Bloque de títulos: todo el bloque está alineado a la izquierda del contenedor -->
            <header class="title-block">
                <!-- fila 1: primario a la izquierda -->
                <div class="title-row title-row-primary">
                <span class="title-primary">Progresa</span>
                </div>

                <!-- fila 2: secundario a la derecha dentro del mismo ancho -->
                <div class="title-row title-row-secondary">
                <span class="title-secondary">Libre</span>
                </div>
            
                <!-- Botón de inscripción -->
                <div class="button-box">
                    {% if is_authenticated %}
                        <a href="{% url 'lista_cursos' %}" class="cta-button">Ver Cursos</a>
                    {% else %}
                        <a href="#" class="cta-button js-open-auth">Inscríbete</a>
                    {% endif %}
                </div>
            </header>
            <!-- Logo en la esquina inferior derecha -->
            <div class="logo-bottom">
            </div>     
            
            <!-- Auth Modal Overlay -->
            <div id="auth-modal" class="auth-overlay hidden">
                <div class="auth-backdrop" data-close-auth></div>
                
                <div class="auth-container">
                    <button class="auth-close" data-close-auth>&times;</button>

                    <!-- Login Header -->
                    <div class="login-header">
                        <h1 class="auth-title">Iniciar Sesión</h1>
                        <p class="auth-subtitle">Bienvenido de vuelta</p>
                    </div>

                    <!-- Login Form -->
                    <form class="login-form">
                        <div class="modern-input-group">
                            <label for="login-username" class="modern-label">Usuario</label>
                            <input id="login-username" name="username" type="text" required class="modern-input" placeholder="Ingresa tu usuario" />
                        </div>

                        <div class="modern-input-group">
                            <label for="login-password" class="modern-label">Contraseña</label>
                            <input id="login-password" name="password" type="password" required class="modern-input" placeholder="Ingresa tu contraseña" />
                        </div>

                        <div class="modern-checkbox-group">
                            <input id="remember" type="checkbox" class="modern-checkbox" name="remember">
                            <label for="remember" class="modern-checkbox-label">Recordarme</label>
                        </div>

                        <button type="submit" class="modern-button">Entrar</button>

                        <div class="auth-links">
                            <p>¿No tienes cuenta? 
                                <button type="button" class="modern-button">Regístrate aquí</button>
                            </p>
                            <p><a href="#HomePage" class="modern-link" data-close-auth>← Volver al inicio</a></p>
                        </div>
                    </form>

                    <!-- Register Header -->
                    <div class="register-header hidden">
                        <h1 class="auth-title">Registrarse</h1>
                        <p class="auth-subtitle">Únete a nuestra comunidad</p>
                    </div>

                    <!-- Register Form -->
                    <form class="register-form hidden">
                        <div class="modern-input-group">
                            <label for="signup-username" class="modern-label">Usuario</label>
                            <input id="signup-username" name="username" type="text" required class="modern-input" placeholder="Elige un usuario" />
                        </div>

                        <div class="modern-input-group">
                            <label for="signup-password1" class="modern-label">Contraseña</label>
                            <input id="signup-password1" name="password1" type="password" required class="modern-input" placeholder="Crea una contraseña" />
                        </div>

                        <div class="modern-input-group">
                            <label for="signup-password2" class="modern-label">Confirmar Contraseña</label>
                            <input id="signup-password2" name="password2" type="password" required class="modern-input" placeholder="Confirma tu contraseña" />
                        </div>

                        <button type="submit" class="modern-button">Registrarme</button>

                        <div class="auth-links">
                            <p>¿Ya tienes cuenta? 
                                <button type="button" class="modern-button">Inicia sesión aquí</button>
                            </p>
                            <p><a href="#HomePage" class="modern-link" data-close-auth>← Volver al inicio</a></p>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Agrega esto justo después del div.logo-bottom si quieres mostrar un botón de logout -->
            {% if is_authenticated %}
            <div class="user-menu">
                <a href="{% url 'usuarios:perfil' %}" class="user-profile-link">
                    {{ user.username }}
                </a>
                <a href="{% url 'usuarios:logout' %}" class="logout-link">
                    Cerrar Sesión
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Sección Quienes Somos -->
<div id="quienes-somos">
    <!-- Título con Logo -->
    <div class="title-logo-box">
        <div class="title-logo">
            <img src="{% static 'img/logo.png' %}?v=1" alt="Logo Progresa">
        </div>
        <h2 class="quienes-somos-title">
            ¿QUIENES SOMOS?
        </h2>
    </div>

    <!-- Contenido principal con imagen y texto -->
    <div class="contenedor-main2">
        <!-- Columna izquierda: Media -->
        <div class="izquierda2">
            <div class="marcos-container">
                <div class="marco">
                    <div class="foto">
                        <!-- Primera imagen -->
                    </div>
                </div>
                <div class="marco">
                    <div class="foto foto-2">
                        <!-- Segunda imagen -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Columna derecha: Texto -->
        <div class="derecha2">
            <div class="quienes-somos-text">
                <p class="first-paragraph">
                    Somos una startup iniciada por estudiantes de la USM, unidos por la convicción de que la educación puede cambiar vidas. Creemos en el poder del conocimiento como herramienta de transformación y queremos derribar las barreras que impiden a muchos jóvenes acceder a formación financiera y en desarrollo sustentable de calidad.
                </p>
                <p>
                    <span class="highlight">Nuestro objetivo es empoderar</span> a las personas entregándoles experiencias de aprendizaje dinámicas, accesibles y gratuitas, que despierten la curiosidad y fomenten decisiones conscientes. Buscamos construir una comunidad que aprenda, crezca y comparta logros, porque estamos convencidos de que juntos podemos forjar un futuro más justo, responsable y lleno de oportunidades.
                </p>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    const modal = document.getElementById('auth-modal');
    const openers = document.querySelectorAll('.js-open-auth');
    const closers = document.querySelectorAll('[data-close-auth]');
    const loginForm = document.querySelector('.login-form');
    const registerForm = document.querySelector('.register-form');
    const registerHeader = document.querySelector('.register-header');
    const loginHeader = document.querySelector('.login-header');
    const homeLinks = document.querySelectorAll('.auth-links a');

    // === Función para obtener token CSRF desde cookies ===
    function getCSRFToken() {
        const name = 'csrftoken';
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                return cookie.substring(name.length + 1);
            }
        }
        return '';
    }

    // --- Mostrar sólo login o registro ---
    function showLogin() {
        loginForm.classList.remove('hidden');
        loginHeader.classList.remove('hidden');
        registerForm.classList.add('hidden');
        registerHeader.classList.add('hidden');
    }

    function showSignup() {
        registerForm.classList.remove('hidden');
        registerHeader.classList.remove('hidden');
        loginForm.classList.add('hidden');
        loginHeader.classList.add('hidden');
    }

    // --- Abrir / cerrar modal ---
    function openModal(defaultTab = 'login', subtitle = null) {
         modal.classList.remove('hidden');
         modal.classList.add('flex');
         defaultTab === 'signup' ? showSignup() : showLogin();
         // Actualizar subtítulo del header de login o register según el tab
         if (subtitle !== null) {
             // loginHeader y registerHeader contienen .auth-subtitle en sus bloques
             if (defaultTab === 'signup') {
                 const sh = registerHeader.querySelector('.auth-subtitle');
                 if (sh) sh.textContent = subtitle;
             } else {
                 const sh = loginHeader.querySelector('.auth-subtitle');
                 if (sh) sh.textContent = subtitle;
             }
         } else {
             // Restablecer subtítulos por defecto si no se pasa subtitle
             const shLogin = loginHeader.querySelector('.auth-subtitle');
             if (shLogin) shLogin.textContent = 'Bienvenido de vuelta';
             const shReg = registerHeader.querySelector('.auth-subtitle');
             if (shReg) shReg.textContent = 'Únete a nuestra comunidad';
         }
         document.body.style.overflow = 'hidden';
     }

    function closeModal() {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        document.body.style.overflow = '';
    }

    // --- Abrir desde botones externos ---
    openers.forEach(el => {
        el.addEventListener('click', function(e) {
            e.preventDefault();
            // Prioriza atributos data-* si están presentes
            const defaultTab = el.dataset.defaultTab || (el.textContent.toLowerCase().includes('inscr') ? 'signup' : 'login');
            const subtitle = el.dataset.subtitle || null;
            openModal(defaultTab, subtitle);
        });
    });
    
    // --- Abrir / cerrar modal ---
    function openModal(defaultTab = 'login', subtitle = null) {
         modal.classList.remove('hidden');
         modal.classList.add('flex');
         defaultTab === 'signup' ? showSignup() : showLogin();
         // Actualizar subtítulo del header de login o register según el tab
         if (subtitle !== null) {
             // loginHeader y registerHeader contienen .auth-subtitle en sus bloques
             if (defaultTab === 'signup') {
                 const sh = registerHeader.querySelector('.auth-subtitle');
                 if (sh) sh.textContent = subtitle;
             } else {
                 const sh = loginHeader.querySelector('.auth-subtitle');
                 if (sh) sh.textContent = subtitle;
             }
         } else {
             // Restablecer subtítulos por defecto si no se pasa subtitle
             const shLogin = loginHeader.querySelector('.auth-subtitle');
             if (shLogin) shLogin.textContent = 'Bienvenido de vuelta';
             const shReg = registerHeader.querySelector('.auth-subtitle');
             if (shReg) shReg.textContent = 'Únete a nuestra comunidad';
         }
         document.body.style.overflow = 'hidden';
     }

    function closeModal() {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        document.body.style.overflow = '';
    }

    // --- Abrir desde botones externos ---
    openers.forEach(el => {
        el.addEventListener('click', function(e) {
            e.preventDefault();
            // Prioriza atributos data-* si están presentes
            const defaultTab = el.dataset.defaultTab || (el.textContent.toLowerCase().includes('inscr') ? 'signup' : 'login');
            const subtitle = el.dataset.subtitle || null;
            openModal(defaultTab, subtitle);
        });
    });

    // --- Cerrar desde overlay o "volver al inicio" ---
    closers.forEach(el => el.addEventListener('click', closeModal));
    homeLinks.forEach(link => {
        link.addEventListener('click', e => {
            e.preventDefault();
            closeModal();
            const href = link.getAttribute('href');
            if (href && href !== '#') {
                window.location.href = href;
            }
        });
    });

    // --- SOLO los botones de cambio entre login/registro (NO los de submit) ---
    // Botón "Regístrate aquí" dentro del login form
    const switchToRegisterBtn = loginForm.querySelector('.auth-links button');
    if (switchToRegisterBtn) {
        switchToRegisterBtn.addEventListener('click', function(e) {
            e.preventDefault();
            showSignup();
        });
    }

    // Botón "Inicia sesión aquí" dentro del register form
    const switchToLoginBtn = registerForm.querySelector('.auth-links button');
    if (switchToLoginBtn) {
        switchToLoginBtn.addEventListener('click', function(e) {
            e.preventDefault();
            showLogin();
        });
    }

    // --- Cerrar modal con tecla Escape ---
    document.addEventListener('keydown', e => {
        if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
            closeModal();
        }
    });

    // --- Autoabrir modal si hay errores del servidor ---
    if (document.body.dataset.hasMessages === 'true') {
        openModal('login');
    }

    // --- LOGIN AJAX ---
    loginForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        console.log('Login submit triggered'); // Debug

        const submitBtn = loginForm.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = 'Entrando...';

        const username = document.getElementById('login-username').value.trim();
        const password = document.getElementById('login-password').value;

        try {
            const response = await fetch("/usuarios/login/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCSRFToken(),
                },
                body: JSON.stringify({ username, password }),
            });

            const data = await response.json();
            console.log("Respuesta login:", data);

            if (data.success) {
                window.location.href = data.redirect || "/usuarios/perfil/";
            } else {
                alert(data.error || "Credenciales incorrectas.");
            }
        } catch (err) {
            console.error(err);
            alert("Error al conectar con el servidor.");
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        }
    });

    // --- REGISTRO AJAX ---
    registerForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        console.log('Registro submit triggered'); // Debug

        const submitBtn = registerForm.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = 'Registrando...';

        const username = document.getElementById('signup-username').value.trim();
        const password1 = document.getElementById('signup-password1').value;
        const password2 = document.getElementById('signup-password2').value;

        console.log('Datos a enviar:', { username, password1, password2 }); // Debug

        try {
            const response = await fetch("/usuarios/registro/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCSRFToken(),
                },
                body: JSON.stringify({ username, password1, password2 }),
            });

            const data = await response.json();
            console.log("Respuesta registro:", data);

            if (data.success) {
                window.location.href = data.redirect || "/usuarios/perfil/";
            } else if (data.errors) {
                const errores = Object.entries(data.errors)
                    .map(([field, msgs]) => `${field}: ${msgs.join(', ')}`)
                    .join('\n');
                alert('Errores en el formulario:\n\n' + errores);
            } else {
                alert(data.error || "Error en el registro.");
            }
        } catch (err) {
            console.error('Error en la petición:', err);
            alert("Error al conectar con el servidor.");
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        }
    });
})();
</script>

<!-- Footer -->
<footer class="bg-gray-800 text-white text-center p-6 mt-16">
    &copy; 2025 Progesa Libre
</footer> 
</html>