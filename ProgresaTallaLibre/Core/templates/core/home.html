{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Progresa Libre</title>

  <!-- Fuentes-->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Alice&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{% static 'css/style.css' %}">
<link rel="icon" type="image/png" size="32x32" href="{% static 'img/logo.png' %}"/>

</head>
<body class="{% if user.is_authenticated %}authenticated{% endif %}" {% if messages %} data-has-messages="true"{% endif %}>

  <!-- HomePage -->
    <div id="HomePage" class="main-container">
        <div class="left-section"></div>
        <div class="divider"></div>
        <div class="right-section">
        
            <nav>
                <div class="separador">
                    <a href="#quienes-somos">¿QUIENES SOMOS?</a>
                    {% if is_authenticated %}
                        <a href="{% url 'lista_cursos' %}">PROGRAMAS</a>
                        <a  class="tuperfillink" href="{% url 'usuarios:perfil' %}">TU PERFIL</a>
                    {% else %}
                        <!-- Abrir modal de login/registro si no está autenticado.
                             data-default-tab: 'login'|'signup'
                             data-subtitle: texto a mostrar en el modal -->
                        <a href="#auth-modal" class="js-open-auth" data-default-tab="login" data-subtitle="Debes iniciar sesión primero">PROGRAMAS</a>
                        <a href="#auth-modal" class="js-open-auth" data-default-tab="login" data-subtitle="Bienvenido de vuelta">TU PERFIL</a>
                    {% endif %}
                </div>
            </nav>

            {% if user.is_authenticated %}
                <div class="user-menu">
                    <a href="{% url 'usuarios:perfil' %}" class="user-profile-link">{{ user.username }}</a>
                    <a href="{% url 'usuarios:logout' %}" class="logout-link">Cerrar Sesión</a>
                </div>
            {% endif %}

            <!-- Bloque de títulos: todo el bloque está alineado a la izquierda del contenedor -->
            <header class="title-block">
                <!-- fila 1: primario a la izquierda -->
                <div class="title-row title-row-primary">
                <span class="title-primary">Progresa</span>
                </div>

                <!-- fila 2: secundario a la derecha dentro del mismo ancho -->
                <div class="title-row title-row-secondary">
                <span class="title-secondary">Libre</span>
                </div>
            
                <!-- Botón de inscripción -->
                <div class="button-box">
                    {% if is_authenticated %}
                        <a href="{% url 'lista_cursos' %}" class="cta-button">Ver Cursos</a>
                    {% else %}
                        <a href="#" class="cta-button js-open-auth">Inscríbete</a>
                    {% endif %}
                </div>
            </header>
            <!-- Logo en la esquina inferior derecha -->
            <div class="logo-bottom">
            </div>     
        </div>
    </div>
</div>

<!-- Sección Quienes Somos -->
<div id="quienes-somos">
    <!-- Título con Logo -->
    <div class="title-logo-box">
        <div class="title-logo">
            <img src="{% static 'img/logo.png' %}?v=1" alt="Logo Progresa">
        </div>
        <h2 class="quienes-somos-title">
            ¿QUIENES SOMOS?
        </h2>
    </div>

    <!-- Contenido principal con imagen y texto -->
    <div class="contenedor-main2">
        <!-- Columna izquierda: Media -->
        <div class="izquierda2">
            <div class="marcos-container">
                <div class="marco">
                    <div class="foto">
                        <!-- Primera imagen -->
                    </div>
                </div>
                <div class="marco">
                    <div class="foto foto-2">
                        <!-- Segunda imagen -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Columna derecha: Texto -->
        <div class="derecha2">
            <div class="quienes-somos-text">
                <p class="first-paragraph">
                    Somos una startup iniciada por estudiantes de la USM, unidos por la convicción de que la educación puede cambiar vidas. Creemos en el poder del conocimiento como herramienta de transformación y queremos derribar las barreras que impiden a muchos jóvenes acceder a formación financiera y en desarrollo sustentable de calidad.
                </p>
                <p>
                    <span class="highlight">Nuestro objetivo es empoderar</span> a las personas entregándoles experiencias de aprendizaje dinámicas, accesibles y gratuitas, que despierten la curiosidad y fomenten decisiones conscientes. Buscamos construir una comunidad que aprenda, crezca y comparta logros, porque estamos convencidos de que juntos podemos forjar un futuro más justo, responsable y lleno de oportunidades.
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Auth Overlay -->
<div id="auth-modal" class="auth-overlay hidden">
    <div class="auth-backdrop" data-close-auth></div>

    <div class="auth-container">
        <button class="auth-close" data-close-auth>&times;</button>

        <!-- Login Header -->
        <div class="login-header">
            <h1 class="auth-title">Iniciar Sesión</h1>
            <p class="auth-subtitle">Bienvenido de vuelta</p>
        </div>

        <!-- Login Form -->
        <form class="login-form">
            <div class="modern-input-group">
                <label for="login-username" class="modern-label">Usuario</label>
                <input id="login-username" name="username" type="text" required class="modern-input" placeholder="Ingresa tu usuario" />
            </div>

            <div class="modern-input-group">
                <label for="login-password" class="modern-label">Contraseña</label>
                <div class="password-input-wrapper">
                    <input id="login-password" name="password" type="password" required class="modern-input" placeholder="Ingresa tu contraseña" />
                    <button type="button" class="toggle-password" onclick="togglePasswordVisibility('login-password', this)">
                        <svg xmlns="http://www.w3.org/2000/svg" class="eye-icon" viewBox="0 0 24 24" width="24" height="24">
                            <path fill="none" stroke="currentColor" stroke-width="2" d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                            <circle fill="none" stroke="currentColor" stroke-width="2" cx="12" cy="12" r="3"/>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="modern-checkbox-group">
                <input id="remember" type="checkbox" class="modern-checkbox" name="remember">
                <label for="remember" class="modern-checkbox-label">Recordarme</label>
            </div>

            <button type="submit" class="modern-button">Entrar</button>

            <div class="auth-links">
                <p>¿No tienes cuenta? 
                    <button type="button" class="modern-button">Regístrate aquí</button>
                </p>
                <p><a href="#HomePage" class="modern-link" data-close-auth>← Volver al inicio</a></p>
            </div>
        </form>

        <!-- Register Header -->
        <div class="register-header hidden">
            <h1 class="auth-title">Registrarse</h1>
            <p class="auth-subtitle">Únete a nuestra comunidad</p>
        </div>

        <!-- Register Form -->
        <form class="register-form hidden">
            <div class="modern-input-group">
                <label for="signup-username" class="modern-label">Usuario</label>
                <input id="signup-username" name="username" type="text" required class="modern-input" placeholder="Elige un usuario" />
            </div>

            <div class="modern-input-group">
                <label for="signup-password1" class="modern-label">Contraseña</label>
                <div class="password-input-wrapper">
                    <input id="signup-password1" name="password1" type="password" required class="modern-input" placeholder="Crea una contraseña" />
                    <button type="button" class="toggle-password" onclick="togglePasswordVisibility('signup-password1', this)">
                        <svg xmlns="http://www.w3.org/2000/svg" class="eye-icon" viewBox="0 0 24 24" width="24" height="24">
                            <path fill="none" stroke="currentColor" stroke-width="2" d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                            <circle fill="none" stroke="currentColor" stroke-width="2" cx="12" cy="12" r="3"/>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="modern-input-group">
                <label for="signup-password2" class="modern-label">Confirmar Contraseña</label>
                <div class="password-input-wrapper">
                    <input id="signup-password2" name="password2" type="password" required class="modern-input" placeholder="Confirma tu contraseña" />
                    <button type="button" class="toggle-password" onclick="togglePasswordVisibility('signup-password2', this)">
                        <svg xmlns="http://www.w3.org/2000/svg" class="eye-icon" viewBox="0 0 24 24" width="24" height="24">
                            <path fill="none" stroke="currentColor" stroke-width="2" d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                            <circle fill="none" stroke="currentColor" stroke-width="2" cx="12" cy="12" r="3"/>
                        </svg>
                    </button>
                </div>
            </div>

            <button type="submit" class="modern-button">Registrarme</button>

            <div class="auth-links">
                <p>¿Ya tienes cuenta? 
                    <button type="button" class="modern-button">Inicia sesión aquí</button>
                </p>
                <p><a href="#HomePage" class="modern-link" data-close-auth>← Volver al inicio</a></p>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const modal = document.getElementById('auth-modal');
    const openers = document.querySelectorAll('.js-open-auth');
    const closers = document.querySelectorAll('[data-close-auth]');
    const loginForm = document.querySelector('.login-form');
    const registerForm = document.querySelector('.register-form');
    const registerHeader = document.querySelector('.register-header');
    const loginHeader = document.querySelector('.login-header');
    const homeLinks = document.querySelectorAll('.auth-links a');

    if (!modal) return; // nada que hacer si no existe el modal

    function getCSRFToken() {
        const name = 'csrftoken';
        const cookies = document.cookie ? document.cookie.split(';') : [];
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                return cookie.substring(name.length + 1);
            }
        }
        return '';
    }

    function showLogin() {
        if (loginForm) loginForm.classList.remove('hidden');
        if (loginHeader) loginHeader.classList.remove('hidden');
        if (registerForm) registerForm.classList.add('hidden');
        if (registerHeader) registerHeader.classList.add('hidden');
    }

    function showSignup() {
        if (registerForm) registerForm.classList.remove('hidden');
        if (registerHeader) registerHeader.classList.remove('hidden');
        if (loginForm) loginForm.classList.add('hidden');
        if (loginHeader) loginHeader.classList.add('hidden');
    }

    function openModal(defaultTab = 'login', subtitle = null) {
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        defaultTab === 'signup' ? showSignup() : showLogin();
        if (subtitle !== null) {
            if (defaultTab === 'signup' && registerHeader) {
                const sh = registerHeader.querySelector('.auth-subtitle');
                if (sh) sh.textContent = subtitle;
            } else if (loginHeader) {
                const sh = loginHeader.querySelector('.auth-subtitle');
                if (sh) sh.textContent = subtitle;
            }
        } else {
            if (loginHeader) {
                const shLogin = loginHeader.querySelector('.auth-subtitle');
                if (shLogin) shLogin.textContent = 'Bienvenido de vuelta';
            }
            if (registerHeader) {
                const shReg = registerHeader.querySelector('.auth-subtitle');
                if (shReg) shReg.textContent = 'Únete a nuestra comunidad';
            }
        }
        document.body.style.overflow = 'hidden';
    }

    function closeModal() {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        document.body.style.overflow = '';
    }

    // event listeners defensivos
    openers.forEach(el => {
        el.addEventListener('click', function (e) {
            e.preventDefault();
            const defaultTab = el.dataset.defaultTab || (el.textContent.toLowerCase().includes('inscr') ? 'signup' : 'login');
            const subtitle = el.dataset.subtitle || null;
            openModal(defaultTab, subtitle);
        });
    });

    closers.forEach(el => el.addEventListener('click', closeModal));
    homeLinks.forEach(link => {
        link.addEventListener('click', e => {
            e.preventDefault();
            closeModal();
            const href = link.getAttribute('href');
            if (href && href !== '#') window.location.href = href;
        });
    });

    const switchToRegisterBtn = loginForm ? loginForm.querySelector('.auth-links button') : null;
    if (switchToRegisterBtn) {
        switchToRegisterBtn.addEventListener('click', function (e) {
            e.preventDefault();
            showSignup();
        });
    }

    const switchToLoginBtn = registerForm ? registerForm.querySelector('.auth-links button') : null;
    if (switchToLoginBtn) {
        switchToLoginBtn.addEventListener('click', function (e) {
            e.preventDefault();
            showLogin();
        });
    }

    document.addEventListener('keydown', e => {
        if (e.key === 'Escape' && !modal.classList.contains('hidden')) closeModal();
    });

    if (document.body.dataset.hasMessages === 'true') openModal('login');

    if (loginForm) {
        loginForm.addEventListener('submit', async function (e) {
            e.preventDefault();
            const submitBtn = loginForm.querySelector('button[type="submit"]');
            const originalText = submitBtn ? submitBtn.textContent : '';
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Entrando...';
            }

            const usernameEl = document.getElementById('login-username');
            const passwordEl = document.getElementById('login-password');
            const username = usernameEl ? usernameEl.value.trim() : '';
            const password = passwordEl ? passwordEl.value : '';

            try {
                const response = await fetch("/usuarios/login/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCSRFToken(),
                    },
                    body: JSON.stringify({ username, password }),
                });
                const data = await response.json();
                if (data.success) {
                    window.location.href = data.redirect || "/usuarios/perfil/";
                } else {
                    alert(data.error || "Credenciales incorrectas.");
                }
            } catch (err) {
                console.error(err);
                alert("Error al conectar con el servidor.");
            } finally {
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                }
            }
        });
    }

    if (registerForm) {
        registerForm.addEventListener('submit', async function (e) {
            e.preventDefault();
            const submitBtn = registerForm.querySelector('button[type="submit"]');
            const originalText = submitBtn ? submitBtn.textContent : '';
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Registrando...';
            }

            const usernameEl = document.getElementById('signup-username');
            const password1El = document.getElementById('signup-password1');
            const password2El = document.getElementById('signup-password2');
            const username = usernameEl ? usernameEl.value.trim() : '';
            const password1 = password1El ? password1El.value : '';
            const password2 = password2El ? password2El.value : '';

            try {
                const response = await fetch("/usuarios/registro/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCSRFToken(),
                    },
                    body: JSON.stringify({ username, password1, password2 }),
                });
                const data = await response.json();
                if (data.success) {
                    window.location.href = data.redirect || "/usuarios/perfil/";
                } else if (data.errors) {
                    const errores = Object.entries(data.errors)
                        .map(([field, msgs]) => `${field}: ${msgs.join(', ')}`)
                        .join('\n');
                    alert('Errores en el formulario:\n\n' + errores);
                } else {
                    alert(data.error || "Error en el registro.");
                }
            } catch (err) {
                console.error('Error en la petición:', err);
                alert("Error al conectar con el servidor.");
            } finally {
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                }
            }
        });
    }

    // Función para alternar la visibilidad de la contraseña
    window.togglePasswordVisibility = function(inputId, button) {
        const input = document.getElementById(inputId);
        const icon = button.querySelector('.eye-icon');
        
        if (input.type === 'password') {
            input.type = 'text';
            // Cambiar el icono a "ojo tachado"
            icon.innerHTML = `
                <path fill="none" stroke="currentColor" stroke-width="2" d="M17.94 17.94A10.07 10.07 0 0112 20c-7 0-11-8-11-8a18.45 18.45 0 015.06-5.94M9.9 4.24A9.12 9.12 0 0112 4c7 0 11 8 11 8a18.5 18.5 0 01-2.16 3.19m-6.72-1.07a3 3 0 11-4.24-4.24"/>
                <line x1="1" y1="1" x2="23" y2="23" stroke="currentColor" stroke-width="2"/>
            `;
        } else {
            input.type = 'password';
            // Cambiar el icono a "ojo normal"
            icon.innerHTML = `
                <path fill="none" stroke="currentColor" stroke-width="2" d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                <circle fill="none" stroke="currentColor" stroke-width="2" cx="12" cy="12" r="3"/>
            `;
        }
    }
});
</script>
</body>
</html>